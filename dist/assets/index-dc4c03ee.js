var he=Object.defineProperty;var be=(e,t,n)=>t in e?he(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var p=(e,t,n)=>(be(e,typeof t!="symbol"?t+"":t,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(o){if(o.ep)return;o.ep=!0;const l=n(o);fetch(o.href,l)}})();class L{constructor(t,n,s,o){p(this,"id");p(this,"name");p(this,"type");p(this,"parentId");p(this,"descr");p(this,"childFolders");p(this,"childFiles");switch(this.id=_e(),this.name=t,this.type=n,this.parentId=s,this.descr=o,n){case"folder":this.childFolders=new Map,this.childFiles=new Map;break;default:this.childFolders=null,this.childFiles=null;break}}}let D=0;function _e(){return D++}function U(e){D=+e}const d={initialize(){ve()},select(){return Fe()},dispatch(e){Se(e)},clear(){we()}};function ve(){if(window.localStorage.getItem("nodeObjId")?U(window.localStorage.getItem("nodeObjId")):(window.localStorage.setItem("nodeObjId","0"),U("0")),!window.localStorage.getItem("folderTreeRoot")){const e=new Map,t=new L("folderTreeRoot","folder",null,"");e.set(t.id,t),window.localStorage.setItem("folderTreeRoot",JSON.stringify(e,j))}}function Fe(){return JSON.parse(window.localStorage.getItem("folderTreeRoot")??"",Ie)}function Se(e){window.localStorage.setItem("folderTreeRoot",JSON.stringify(e,j)),window.localStorage.setItem("nodeObjId",D+"")}function we(){const e=new Map,t=new L("folderTreeRoot","folder",null,"");e.set(t.id,t),window.localStorage.setItem("folderTreeRoot",JSON.stringify(e,j)),window.localStorage.setItem("nodeObjId","0")}function j(e,t){return t instanceof Map?{dataType:"Map",value:Array.from(t.entries())}:t instanceof Set?{dataType:"Set",value:Array.from(t.keys())}:t}function Ie(e,t){if(typeof t=="object"&&t!==null){if(t.dataType==="Map")return new Map(t.value);if(t.dataType==="Set")return new Set(t.value)}return t}const m={initialize(){Ee()},select(){return xe()},dispatch(e){Le(e)},clear(){qe()}};function Ee(){if(!window.localStorage.getItem("fileMap")){const e=new Map;window.localStorage.setItem("fileMap",JSON.stringify(e,N))}}function xe(){return JSON.parse(window.localStorage.getItem("fileMap")??"",Me)}function Le(e){window.localStorage.setItem("fileMap",JSON.stringify(e,N))}function qe(){window.localStorage.removeItem("fileMap");const e=new Map;window.localStorage.setItem("fileMap",JSON.stringify(e,N))}function N(e,t){return t instanceof Map?{dataType:"Map",value:Array.from(t.entries())}:t instanceof Set?{dataType:"Set",value:Array.from(t.keys())}:t}function Me(e,t){if(typeof t=="object"&&t!==null){if(t.dataType==="Map")return new Map(t.value);if(t.dataType==="Set")return new Set(t.value)}return t}let oe;const f={openDb(){Ce()},deleteDatabase(){$e()},getFileStore(e){return le(e)},clearFileStore(){ke()},addFile(e,t){Te(e,t)},getFile(e,t,n){Be(e,t,n)},deleteFile(e,t){Ae(e,t)}};function Ce(){console.log("openDb ...");let e=indexedDB.open("filedb",1);e.onsuccess=t=>{oe=e.result,console.log("openDb success")},e.onerror=t=>{console.error("openDb:",e.error)},e.onupgradeneeded=t=>{console.log("openDb.onupgradeneeded"),e.result.createObjectStore("files",{keyPath:"id"})}}function le(e){let t=oe.transaction("files",e);return t.oncomplete=()=>{console.log("getFileStore complete")},t.onerror=n=>{console.error(`getFileStore ${e}:`,t.error)},t.objectStore("files")}function ke(){let t=le("readwrite").clear();t.onsuccess=n=>{console.log("clearFileStore success")},t.onerror=n=>{console.error("clearFileStore:",t.error)}}function $e(){let e=indexedDB.deleteDatabase("filedb");e.onsuccess=()=>{console.log("deleteDatabase success")},e.onerror=t=>{console.log("deleteDatabase:",e.error)}}function Te(e,t){let n=t.add(e);n.onsuccess=s=>{console.log("addFile success")},n.onerror=s=>{console.error("addFile:",n.error)}}function Be(e,t,n){let s=t.get(e);s.onsuccess=o=>{let l=s.result;l&&n(l),console.log("getFile success")},s.onerror=o=>{console.error("getFile:",s.error)}}function Ae(e,t){let n=t.delete(e);n.onsuccess=s=>{console.log("deleteFile success")},n.onerror=s=>{console.error("deleteFile:",n.error)}}const De=/^.*\.$/,je=/[<>:"|?*\\/]+/;function R(e){return!(e.length===0||De.test(e)||je.test(e))}function se(){const e=document.createElement("form");e.className="form",e.id="node-props",e.innerHTML=`<label for="nodename">
                        <span>Название:</span>
                        <input id="nodename" name="nodename" type="text"/>
                    </label>
                    <label for="nodedescr">
                        <span>Описание:</span>
                        <input id="nodedescr" name="nodedescr" type="text" />
                    </label>
                    <button type="submit" form="node-props">ОК</button>`;const t=e.elements;return t.nodename.oninput=()=>{R(t.nodename.value)&&t.nodename.setCustomValidity("")},e.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),e.dispatchEvent(new Event("submit")))}),e}let C=null;function B(e){C&&C.classList.remove("file__content_active"),e==null||e.classList.add("file__content_active"),C=e}function Ne(e){const t=document.createElement("div"),n=document.createElement("pre");t.append(n),t.className+="file__content",t.dataset.objId=String(e);const s=f.getFileStore("readonly");return f.getFile(e,s,o=>{let l=new FileReader;l.readAsText(o.file),l.onload=function(){n.textContent=l.result},l.onerror=function(){n.textContent="Ошибка загрузки файла",console.log(l.error)}}),t}let k=null;const O=document.getElementById("tabs"),Re=document.getElementById("file-window");function E(e){k&&k.classList.remove("tab_active"),e==null||e.classList.add("tab_active"),k=e}function ze(e){const t=document.createElement("article");t.className+="tab";const n=document.createElement("img");return n.className="file__close",n.src="/close.svg",n.alt="X",t.textContent=e.name,t.append(n),t.dataset.objId=String(e.id),t.onclick=()=>{console.log("click",t);const s=document.querySelector(`.file__content[data-obj-id="${e.id}"]`);E(t),B(s)},n.onclick=s=>{s.stopPropagation();const o=document.querySelector(`.file__content[data-obj-id="${e.id}"]`);if(t.remove(),o==null||o.remove(),!O||!Re)return;const l=O.querySelector(".tab");E(l),l==null||l.dispatchEvent(new Event("click"))},t}let re=null;const Pe=()=>re,ie=e=>{re=e,console.log("chosen node",e)};function q(e,t){const n=document.querySelector(".description");n&&(e.onmouseover=s=>{t&&(n.style.top=`${s.clientY+12}px`,n.style.left=`${s.clientX+12}px`,n.style.display="initial",n.textContent=t,n.style.opacity="1")},e.onmouseleave=s=>{t&&(n.style.opacity="0",n.style.display="none",n.textContent="")})}let A=null;const $=document.getElementById("tabs"),T=document.getElementById("file-window"),ce=()=>A,ae=e=>{if(!e){A=null;return}const t=e.closest(".folder");t&&M(t),A=e,console.log("chosen file",e),console.log("chosen parent",t)};function de(e){const t=document.createElement("article");t.className+="node file",t.innerHTML=`<div class="node__heading" tabindex="-1">
                        <img src="/file.svg" class="node-icon" />
                        <h3 class="node__name">
                        </h3>
                    </div>`,t.dataset.objId=String(e.id);const n=t.querySelector(".node__name");n&&(n.textContent=e.name);const s=t.querySelector(".node__heading");return s&&(q(s,e.descr),s.tabIndex=-1,s.onfocus=()=>{ae(t),ie(t)},s.ondblclick=()=>{if(!$||!T)return;const o=$.querySelector(`.tab[data-obj-id="${e.id}"]`),l=T.querySelector(`.file__content[data-obj-id="${e.id}"]`);if(o&&l)E(o),B(l);else{const r=ze(e),i=Ne(e.id);$.prepend(r),T.prepend(i),E(r),B(i)}}),t}function ue(e){Array.from(e.children).sort((n,s)=>{const o=n.querySelector("article"),l=s.querySelector("article");return o!=null&&o.classList.contains("folder")&&(l!=null&&l.classList.contains("file"))?1:o!=null&&o.classList.contains("file")&&(l!=null&&l.classList.contains("folder"))?-1:0}).sort((n,s)=>{var r,i;const o=((r=n.querySelector(".node__name"))==null?void 0:r.textContent)??"",l=((i=s.querySelector(".node__name"))==null?void 0:i.textContent)??"";return o.toLocaleLowerCase().localeCompare(l.toLocaleLowerCase())}).forEach(n=>{e.append(n)})}let I=document.getElementById("structure-root");function z(e){var r,i;const t=e===0?I:I==null?void 0:I.querySelector(`.folder[data-obj-id="${e}"]`),n=d.select(),s=m.select(),o=n.get(e),l=t==null?void 0:t.querySelector(".node__children");l&&(l.innerHTML=""),(r=o.childFolders)==null||r.forEach((c,a)=>{const y=me(n.get(a)),h=document.createElement("li");h.append(y),l==null||l.insertAdjacentElement("beforeend",h)}),(i=o.childFiles)==null||i.forEach((c,a)=>{const y=de(s.get(a)),h=document.createElement("li");h.append(y),l==null||l.insertAdjacentElement("beforeend",h)}),ue(l)}let He=document.getElementById("structure-root"),fe=He;const P=()=>fe,M=e=>{fe=e,console.log("chosen folder",e)},Je=e=>{if(e[0].type!=="childList")return;const n=e[0].target.closest(".folder"),s=d.select(),o=n==null?void 0:n.querySelector(".arrow"),l=n==null?void 0:n.querySelector(".node-icon");if(!o||!n||!l)return;const r=s.get(+n.dataset.objId);r!=null&&r.childFiles&&(r==null?void 0:r.childFiles.size)>0||r!=null&&r.childFolders&&r.childFolders.size>0?(o.style.visibility="visible",n.dataset.expandable="1"):(o.style.visibility="hidden",n.dataset.expandable="0",l.src="/folder.svg")},Ue=new MutationObserver(Je);function me(e){var l,r;const t=document.createElement("article");t.className+="node folder",t.innerHTML=`<div class="node__heading">
                            <img src="/folder-arrow.svg" class="arrow" />
                            <img src="/folder.svg" class="node-icon" />
                            <h3 class="node__name">
                            </h3>
                        </div>
                        <div class="node__expander">
                            <ul class="node__children">
                            </ul>
                        </div>`,t.dataset.objId=String(e.id),t.dataset.expandable="0";const n=t.querySelector(".node__name");n&&(n.textContent=e.name);const s=t.querySelector(".node__children"),o=t.querySelector(".node__heading");if(o&&s){Ue.observe(s,{childList:!0,subtree:!1}),q(o,e.descr),o.tabIndex=-1,o.onfocus=()=>{M(t),ie(t)};const i=t.querySelector(".node__expander"),c=t.querySelector(".arrow"),a=t.querySelector(".node-icon");(e.childFiles&&((l=e.childFiles)==null?void 0:l.size)>0||e.childFolders&&((r=e.childFolders)==null?void 0:r.size)>0)&&(c&&(c.style.visibility="visible"),t.dataset.expandable="1"),o.onclick=()=>{t.dataset.expandable!=="1"||!a||(i!=null&&i.classList.contains("node__expander_expanded")?(i.classList.remove("node__expander_expanded"),a.src="/folder.svg",c==null||c.classList.remove("arrow_open"),s.innerHTML=""):(i==null||i.classList.add("node__expander_expanded"),a.src="/folder-opened.svg",c==null||c.classList.add("arrow_open"),z(e.id)))}}return t}function H(e,t){const n=document.createElement("div"),s=document.createElement("div"),o=document.createElement("div");return n.className="modal",s.className="modal__overlay",o.className="modal__container",n.insertAdjacentElement("afterbegin",o),n.insertAdjacentElement("afterbegin",s),o.insertAdjacentElement("afterbegin",e),s.onclick=()=>{t(),n.remove()},n}function x(e,t,n,s){if(t.includes(n))switch(s){case"file":{const o=/^(.*?)(\.[^.]*)?$/,l=n.match(o);if(l){const r=l[1]+" (копия)"+(l[2]??"");return x(e,t,r,s)}break}default:{const o=n+" (копия)";return x(e,t,o,s)}}return n}function S(e){return e.trim().replace(/\s\s+/g," ")}function J(e){const t=e.elements;return R(t.nodename.value)?!0:(t.nodename.setCustomValidity("Некорректное название"),!1)}function pe(e,t,n,s){if(t!==0){const o=e.querySelector(".node__expander"),l=e.querySelector(".arrow"),r=e.querySelector(".node-icon");r&&l&&(e.dataset.expandable="1",o==null||o.classList.add("node__expander_expanded"),r.src="/folder-opened.svg",l.style.visibility="visible",l.classList.add("arrow_open"),z(+t))}else{const o=document.createElement("li"),l=e==null?void 0:e.querySelector(".node__children"),r=s(n);l&&(o.insertAdjacentElement("afterbegin",r),l.insertAdjacentElement("beforeend",o),ue(l))}}const Oe=document.getElementById("structure-root");document.addEventListener("click",e=>{e.target.id==="structure-root"&&M(Oe)});function Ke(e,t){var i;let n=P();const s=(n==null?void 0:n.dataset.objId)??0,o=d.select(),l=o.get(+s);if(l&&l.childFiles&&l.childFolders){const c=Array.from(l.childFiles.values()).concat(Array.from(l.childFolders.values()));e=x(l,c,e,"folder")}const r=new L(e,"folder",+s,t);(i=l==null?void 0:l.childFolders)==null||i.set(r.id,r.name),o.set(r.id,r),d.dispatch(o),pe(n,+s,r,me)}const K=document.getElementById("create-folder"),_=se(),b=_.elements,V=H(_,()=>{_.reset()});K&&(K.onclick=()=>{_.onsubmit=e=>{e.preventDefault(),b.nodename.value=S(b.nodename.value),b.nodedescr.value=S(b.nodedescr.value),J(_)&&(Ke(b.nodename.value,b.nodedescr.value),_.reset(),V.remove())},document.body.insertAdjacentElement("beforeend",V)});function ge(e,t,n,s){var o,l;e.childFiles&&((o=e.childFiles)==null||o.forEach((r,i)=>{n.delete(i),f.deleteFile(i,s)})),e.childFolders&&((l=e.childFolders)==null||l.forEach((r,i)=>{const c=t.get(i);ge(c,n,t,s),t.delete(i)}))}const w=document.getElementById("structure-root");function Ve(){var y;let e=P();if(!e)return;const t=+(e.dataset.objId??0);if(t===0)return;const n=e==null?void 0:e.parentElement,s=d.select(),o=m.select(),l=s.get(t),r=f.getFileStore("readwrite");ge(l,s,o,r);const i=l.parentId,c=s.get(i);(y=c==null?void 0:c.childFolders)==null||y.delete(t),s.delete(t),m.dispatch(o),d.dispatch(s);const a=i===0?w:w==null?void 0:w.querySelector(`.folder[data-obj-id="${i}"]`);M(a??w),n==null||n.remove()}const W=document.getElementById("delete-folder");W&&(W.onclick=()=>{Ve()});const X=document.getElementById("clear-app");X&&(X.onclick=()=>{window.localStorage.clear(),f.deleteDatabase(),location.reload()});function We(){var a;let e=ce();if(!e)return;const t=+e.dataset.objId,n=e==null?void 0:e.parentElement,s=d.select(),o=m.select(),l=f.getFileStore("readwrite");f.deleteFile(t,l);const i=o.get(t).parentId,c=s.get(i);(a=c==null?void 0:c.childFiles)==null||a.delete(t),o.delete(t),m.dispatch(o),d.dispatch(s),ae(null),n==null||n.remove()}const Y=document.getElementById("delete-file");Y&&(Y.onclick=()=>{We()});function Xe(){const e=document.createElement("form");e.className="form",e.id="file-upload",e.innerHTML=`<label class="file" for="loadfile">
                        <input id="loadfile" name="loadfile" type="file" required/>
                        <span class="file__btn">Выберите файл</span> 
                    </label>
                    <label for="nodename">
                        <span>Название:</span>
                        <input  id="nodename" name="nodename" type="text" />
                    </label>
                    <label for="nodedescr">
                        <span>Описание:</span>
                        <input id="nodedescr" name="nodedescr" type="text" />
                    </label>
                    <button type="submit" form="file-upload">ОК</button>`;const t=e.elements;return t.loadfile.onchange=n=>{if(!t.loadfile.files)return;const s=t.loadfile.files[0];t.nodename.value=s.name},t.loadfile.onclick=n=>{t.loadfile.value=""},t.nodename.oninput=()=>{R(t.nodename.value)&&t.nodename.setCustomValidity("")},document.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),e.dispatchEvent(new Event("submit")))}),e}class Ye{constructor(t,n){p(this,"id");p(this,"file");this.id=t,this.file=n}}function Ge(e,t,n){var h;let s=P();const o=(s==null?void 0:s.dataset.objId)??0,l=d.select(),r=m.select(),i=l.get(+o),c=f.getFileStore("readwrite");if(i&&i.childFiles&&i.childFolders){const ye=Array.from(i.childFiles.values()).concat(Array.from(i.childFolders.values()));e=x(i,ye,e,"file")}const a=new L(e,"file",+o,t),y=new Ye(a.id,n);f.addFile(y,c),(h=i==null?void 0:i.childFiles)==null||h.set(a.id,a.name),r.set(a.id,a),m.dispatch(r),d.dispatch(l),pe(s,+o,a,de)}const G=document.getElementById("upload-file"),v=Xe(),g=v.elements,Q=H(v,()=>{v.reset()});G&&(G.onclick=()=>{v.onsubmit=e=>{if(e.preventDefault(),g.nodename.value=S(g.nodename.value),g.nodedescr.value=S(g.nodedescr.value),!J(v)||!g.loadfile.files||!g.loadfile.files[0])return;let n=g.loadfile.files[0];console.log(n),Ge(g.nodename.value,g.nodedescr.value,n),v.reset(),Q.remove()},document.body.insertAdjacentElement("beforeend",Q)});function Qe(){let e=ce();if(!e)return;const t=+e.dataset.objId,n=f.getFileStore("readonly"),o=m.select().get(t);f.getFile(t,n,l=>{console.log("success"),Ze(l.file,o.name)})}const Ze=(e,t)=>{let n=document.createElement("a");n.style.display="none",document.body.appendChild(n);const s=window.URL.createObjectURL(e);console.log(s),n.href=s,n.download=t,n.click(),window.URL.revokeObjectURL(s),n.remove()},Z=document.getElementById("download-file");Z&&(Z.onclick=()=>{Qe()});const ee=document.getElementById("tabs");function et(e,t,n,s,o,l){var c;const r=e.querySelector(".node__name");if(r&&(r.textContent=o,q(r,l)),ee){const a=ee.querySelector(`.tab[data-obj-id="${t.id}"]`);a&&(a.textContent=o)}t.name=o,t.descr=l,n.set(t.id,t),m.dispatch(n);const i=s.get(t.parentId);i&&((c=i.childFiles)==null||c.set(t.id,o),s.set(i==null?void 0:i.id,i),d.dispatch(s))}function tt(e,t,n,s,o){var i;const l=e.querySelector(".node__name");l&&(l.textContent=s,q(l,o)),t.name=s,t.descr=o,n.set(t.id,t);const r=n.get(t.parentId);r&&((i=r.childFiles)==null||i.set(t.id,s),n.set(r==null?void 0:r.id,r),d.dispatch(n))}const te=document.getElementById("update-node"),F=se(),u=F.elements,ne=H(F,()=>{F.reset()});te&&(te.onclick=()=>{const e=Pe();if(!e)return;const t=+e.dataset.objId;if(t===0)return;const n=d.select(),s=m.select();let o;n.has(t)?(o=n.get(t),u.nodename.value=o.name,u.nodedescr.value=o.descr):s.has(t)&&(o=s.get(t),u.nodename.value=o.name,u.nodedescr.value=o.descr),F.onsubmit=l=>{if(l.preventDefault(),u.nodename.value=S(u.nodename.value),u.nodedescr.value=S(u.nodedescr.value),!!J(F)){switch(o.type){case"file":{et(e,o,s,n,u.nodename.value,u.nodedescr.value);break}default:{tt(e,o,n,u.nodename.value,u.nodedescr.value);break}}F.reset(),ne.remove()}},document.body.insertAdjacentElement("beforeend",ne)});f.openDb();d.initialize();m.initialize();z(0);
