var be=Object.defineProperty;var _e=(e,t,n)=>t in e?be(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var g=(e,t,n)=>(_e(e,typeof t!="symbol"?t+"":t,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(o){if(o.ep)return;o.ep=!0;const l=n(o);fetch(o.href,l)}})();class q{constructor(t,n,s,o){g(this,"id");g(this,"name");g(this,"type");g(this,"parentId");g(this,"descr");g(this,"childFolders");g(this,"childFiles");switch(this.id=ve(),this.name=t,this.type=n,this.parentId=s,this.descr=o,n){case"folder":this.childFolders=new Map,this.childFiles=new Map;break;default:this.childFolders=null,this.childFiles=null;break}}}let j=0;function ve(){return j++}function O(e){j=+e}const d={initialize(){Fe()},select(){return Se()},dispatch(e){we(e)},clear(){Ie()}};function Fe(){if(window.localStorage.getItem("nodeObjId")?O(window.localStorage.getItem("nodeObjId")):(window.localStorage.setItem("nodeObjId","0"),O("0")),!window.localStorage.getItem("folderTreeRoot")){const e=new Map,t=new q("folderTreeRoot","folder",null,"");e.set(t.id,t),window.localStorage.setItem("folderTreeRoot",JSON.stringify(e,N))}}function Se(){return JSON.parse(window.localStorage.getItem("folderTreeRoot")??"",Ee)}function we(e){window.localStorage.setItem("folderTreeRoot",JSON.stringify(e,N)),window.localStorage.setItem("nodeObjId",j+"")}function Ie(){const e=new Map,t=new q("folderTreeRoot","folder",null,"");e.set(t.id,t),window.localStorage.setItem("folderTreeRoot",JSON.stringify(e,N)),window.localStorage.setItem("nodeObjId","0")}function N(e,t){return t instanceof Map?{dataType:"Map",value:Array.from(t.entries())}:t instanceof Set?{dataType:"Set",value:Array.from(t.keys())}:t}function Ee(e,t){if(typeof t=="object"&&t!==null){if(t.dataType==="Map")return new Map(t.value);if(t.dataType==="Set")return new Set(t.value)}return t}const p={initialize(){xe()},select(){return Le()},dispatch(e){qe(e)},clear(){Me()}};function xe(){if(!window.localStorage.getItem("fileMap")){const e=new Map;window.localStorage.setItem("fileMap",JSON.stringify(e,R))}}function Le(){return JSON.parse(window.localStorage.getItem("fileMap")??"",Ce)}function qe(e){window.localStorage.setItem("fileMap",JSON.stringify(e,R))}function Me(){window.localStorage.removeItem("fileMap");const e=new Map;window.localStorage.setItem("fileMap",JSON.stringify(e,R))}function R(e,t){return t instanceof Map?{dataType:"Map",value:Array.from(t.entries())}:t instanceof Set?{dataType:"Set",value:Array.from(t.keys())}:t}function Ce(e,t){if(typeof t=="object"&&t!==null){if(t.dataType==="Map")return new Map(t.value);if(t.dataType==="Set")return new Set(t.value)}return t}let le;const f={openDb(){$e()},deleteDatabase(){Te()},getFileStore(e){return se(e)},clearFileStore(){ke()},addFile(e,t){Be(e,t)},getFile(e,t,n){Ae(e,t,n)},deleteFile(e,t){De(e,t)}};function $e(){console.log("openDb ...");let e=indexedDB.open("filedb",1);e.onsuccess=t=>{le=e.result,console.log("openDb success")},e.onerror=t=>{console.error("openDb:",e.error)},e.onupgradeneeded=t=>{console.log("openDb.onupgradeneeded"),e.result.createObjectStore("files",{keyPath:"id"})}}function se(e){let t=le.transaction("files",e);return t.oncomplete=()=>{console.log("getFileStore complete")},t.onerror=n=>{console.error(`getFileStore ${e}:`,t.error)},t.objectStore("files")}function ke(){let t=se("readwrite").clear();t.onsuccess=n=>{console.log("clearFileStore success")},t.onerror=n=>{console.error("clearFileStore:",t.error)}}function Te(){let e=indexedDB.deleteDatabase("filedb");e.onsuccess=()=>{console.log("deleteDatabase success")},e.onerror=t=>{console.log("deleteDatabase:",e.error)}}function Be(e,t){let n=t.add(e);n.onsuccess=s=>{console.log("addFile success")},n.onerror=s=>{console.error("addFile:",n.error)}}function Ae(e,t,n){let s=t.get(e);s.onsuccess=o=>{let l=s.result;l&&n(l),console.log("getFile success")},s.onerror=o=>{console.error("getFile:",s.error)}}function De(e,t){let n=t.delete(e);n.onsuccess=s=>{console.log("deleteFile success")},n.onerror=s=>{console.error("deleteFile:",n.error)}}const je=/^.*\.$/,Ne=/[<>:"|?*\\/]+/;function z(e){return!(e.length===0||je.test(e)||Ne.test(e))}function re(){const e=document.createElement("form");e.className="form",e.id="node-props",e.innerHTML=`<label for="nodename">
                        <span>Название:</span>
                        <input id="nodename" name="nodename" type="text"/>
                    </label>
                    <label for="nodedescr">
                        <span>Описание:</span>
                        <input id="nodedescr" name="nodedescr" type="text" />
                    </label>
                    <button type="submit" form="node-props">ОК</button>`;const t=e.elements;return t.nodename.oninput=()=>{z(t.nodename.value)&&t.nodename.setCustomValidity("")},e.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),e.dispatchEvent(new Event("submit")))}),e}let $=null;function A(e){$&&$.classList.remove("file__content_active"),e==null||e.classList.add("file__content_active"),$=e}function Re(e){const t=document.createElement("div"),n=document.createElement("pre");t.append(n),t.className+="file__content",t.dataset.objId=String(e);const s=f.getFileStore("readonly");return f.getFile(e,s,o=>{let l=new FileReader;l.readAsText(o.file),l.onload=function(){n.textContent=l.result},l.onerror=function(){n.textContent="Ошибка загрузки файла",console.log(l.error)}}),t}let k=null;const K=document.getElementById("tabs"),ze=document.getElementById("file-window");function x(e){k&&k.classList.remove("tab_active"),e==null||e.classList.add("tab_active"),k=e}function Pe(e){const t=document.createElement("article"),n=document.createElement("div");n.className="tab__filename",t.className+="tab";const s=document.createElement("img");return s.className="file__close",s.src=`${b}/close.svg`,s.alt="X",n.textContent=e.name,t.append(n),t.append(s),t.dataset.objId=String(e.id),t.onclick=()=>{console.log("click",t);const o=document.querySelector(`.file__content[data-obj-id="${e.id}"]`);x(t),A(o)},s.onclick=o=>{o.stopPropagation();const l=document.querySelector(`.file__content[data-obj-id="${e.id}"]`);if(t.remove(),l==null||l.remove(),!K||!ze)return;const r=K.querySelector(".tab");x(r),r==null||r.dispatchEvent(new Event("click"))},t}let ie=null;const He=()=>ie,ce=e=>{ie=e,console.log("chosen node",e)};function M(e,t){const n=document.querySelector(".description");n&&(e.onmouseover=s=>{t&&(n.style.top=`${s.clientY+12}px`,n.style.left=`${s.clientX+12}px`,n.style.display="initial",n.textContent=t,n.style.opacity="1")},e.onmouseleave=s=>{t&&(n.style.opacity="0",n.style.display="none",n.textContent="")})}let D=null;const T=document.getElementById("tabs"),B=document.getElementById("file-window"),ae=()=>D,de=e=>{if(!e){D=null;return}const t=e.closest(".folder");t&&C(t),D=e,console.log("chosen file",e),console.log("chosen parent",t)};function ue(e){const t=document.createElement("article");t.className+="node file",t.innerHTML=`<div class="node__heading" tabindex="-1">
                        <img src="${b}/file.svg" class="node-icon" />
                        <h3 class="node__name">
                        </h3>
                    </div>`,t.dataset.objId=String(e.id);const n=t.querySelector(".node__name");n&&(n.textContent=e.name);const s=t.querySelector(".node__heading");return s&&(M(s,e.descr),s.tabIndex=-1,s.onfocus=()=>{de(t),ce(t)},s.ondblclick=()=>{if(!T||!B)return;const o=T.querySelector(`.tab[data-obj-id="${e.id}"]`),l=B.querySelector(`.file__content[data-obj-id="${e.id}"]`);if(o&&l)x(o),A(l);else{const r=Pe(e),i=Re(e.id);T.prepend(r),B.prepend(i),x(r),A(i)}}),t}function fe(e){Array.from(e.children).sort((n,s)=>{var r,i;const o=((r=n.querySelector(".node__name"))==null?void 0:r.textContent)??"",l=((i=s.querySelector(".node__name"))==null?void 0:i.textContent)??"";return o.toLocaleLowerCase().localeCompare(l.toLocaleLowerCase())}).sort((n,s)=>{const o=n.querySelector("article"),l=s.querySelector("article");return o!=null&&o.classList.contains("folder")&&(l!=null&&l.classList.contains("file"))?-1:o!=null&&o.classList.contains("file")&&(l!=null&&l.classList.contains("folder"))?1:0}).forEach(n=>{e.append(n)})}let E=document.getElementById("structure-root");function P(e){var r,i;const t=e===0?E:E==null?void 0:E.querySelector(`.folder[data-obj-id="${e}"]`),n=d.select(),s=p.select(),o=n.get(e),l=t==null?void 0:t.querySelector(".node__children");l&&(l.innerHTML=""),(r=o.childFolders)==null||r.forEach((c,a)=>{const m=pe(n.get(a)),h=document.createElement("li");h.append(m),l==null||l.insertAdjacentElement("beforeend",h)}),(i=o.childFiles)==null||i.forEach((c,a)=>{const m=ue(s.get(a)),h=document.createElement("li");h.append(m),l==null||l.insertAdjacentElement("beforeend",h)}),fe(l)}let Je=document.getElementById("structure-root"),me=Je;const H=()=>me,C=e=>{me=e,console.log("chosen folder",e)},Ue=e=>{if(e[0].type!=="childList")return;const n=e[0].target.closest(".folder"),s=d.select(),o=n==null?void 0:n.querySelector(".arrow"),l=n==null?void 0:n.querySelector(".node-icon");if(!o||!n||!l)return;const r=s.get(+n.dataset.objId);r!=null&&r.childFiles&&(r==null?void 0:r.childFiles.size)>0||r!=null&&r.childFolders&&r.childFolders.size>0?(o.style.visibility="visible",n.dataset.expandable="1"):(o.style.visibility="hidden",n.dataset.expandable="0",l.src=`${b}/folder.svg`)},Oe=new MutationObserver(Ue);function pe(e){var l,r;const t=document.createElement("article");t.className+="node folder",t.innerHTML=`<div class="node__heading">
                            <img src="${b}/folder-arrow.svg" class="arrow" />
                            <img src="${b}/folder.svg" class="node-icon" />
                            <h3 class="node__name">
                            </h3>
                        </div>
                        <div class="node__expander">
                            <ul class="node__children">
                            </ul>
                        </div>`,t.dataset.objId=String(e.id),t.dataset.expandable="0";const n=t.querySelector(".node__name");n&&(n.textContent=e.name);const s=t.querySelector(".node__children"),o=t.querySelector(".node__heading");if(o&&s){Oe.observe(s,{childList:!0,subtree:!1}),M(o,e.descr),o.tabIndex=-1,o.onfocus=()=>{C(t),ce(t)};const i=t.querySelector(".node__expander"),c=t.querySelector(".arrow"),a=t.querySelector(".node-icon");(e.childFiles&&((l=e.childFiles)==null?void 0:l.size)>0||e.childFolders&&((r=e.childFolders)==null?void 0:r.size)>0)&&(c&&(c.style.visibility="visible"),t.dataset.expandable="1"),o.onclick=()=>{t.dataset.expandable!=="1"||!a||(i!=null&&i.classList.contains("node__expander_expanded")?(i.classList.remove("node__expander_expanded"),a.src=`${b}/folder.svg`,c==null||c.classList.remove("arrow_open"),s.innerHTML=""):(i==null||i.classList.add("node__expander_expanded"),a.src=`${b}/folder-opened.svg`,c==null||c.classList.add("arrow_open"),P(e.id)))}}return t}function J(e,t){const n=document.createElement("div"),s=document.createElement("div"),o=document.createElement("div");return n.className="modal",s.className="modal__overlay",o.className="modal__container",n.insertAdjacentElement("afterbegin",o),n.insertAdjacentElement("afterbegin",s),o.insertAdjacentElement("afterbegin",e),s.onclick=()=>{t(),n.remove()},n}function L(e,t,n,s){if(t.includes(n))switch(s){case"file":{const o=/^(.*?)(\.[^.]*)?$/,l=n.match(o);if(l){const r=l[1]+" (копия)"+(l[2]??"");return L(e,t,r,s)}break}default:{const o=n+" (копия)";return L(e,t,o,s)}}return n}function w(e){return e.trim().replace(/\s\s+/g," ")}function U(e){const t=e.elements;return z(t.nodename.value)?!0:(t.nodename.setCustomValidity("Некорректное название"),!1)}function ge(e,t,n,s){if(t!==0){const o=e.querySelector(".node__expander"),l=e.querySelector(".arrow"),r=e.querySelector(".node-icon");r&&l&&(e.dataset.expandable="1",o==null||o.classList.add("node__expander_expanded"),r.src=`${b}/folder-opened.svg`,l.style.visibility="visible",l.classList.add("arrow_open"),P(+t))}else{const o=document.createElement("li"),l=e==null?void 0:e.querySelector(".node__children"),r=s(n);l&&(o.insertAdjacentElement("afterbegin",r),l.insertAdjacentElement("beforeend",o),fe(l))}}const Ke=document.getElementById("structure-root");document.addEventListener("click",e=>{e.target.id==="structure-root"&&C(Ke)});function Ve(e,t){var i;let n=H();const s=(n==null?void 0:n.dataset.objId)??0,o=d.select(),l=o.get(+s);if(l&&l.childFiles&&l.childFolders){const c=Array.from(l.childFiles.values()).concat(Array.from(l.childFolders.values()));e=L(l,c,e,"folder")}const r=new q(e,"folder",+s,t);(i=l==null?void 0:l.childFolders)==null||i.set(r.id,r.name),o.set(r.id,r),d.dispatch(o),ge(n,+s,r,pe)}const V=document.getElementById("create-folder"),v=re(),_=v.elements,W=J(v,()=>{v.reset()});V&&(V.onclick=()=>{v.onsubmit=e=>{e.preventDefault(),_.nodename.value=w(_.nodename.value),_.nodedescr.value=w(_.nodedescr.value),U(v)&&(Ve(_.nodename.value,_.nodedescr.value),v.reset(),W.remove())},document.body.insertAdjacentElement("beforeend",W)});function ye(e,t,n,s){var o,l;e.childFiles&&((o=e.childFiles)==null||o.forEach((r,i)=>{n.delete(i),f.deleteFile(i,s)})),e.childFolders&&((l=e.childFolders)==null||l.forEach((r,i)=>{const c=t.get(i);ye(c,n,t,s),t.delete(i)}))}const I=document.getElementById("structure-root");function We(){var m;let e=H();if(!e)return;const t=+(e.dataset.objId??0);if(t===0)return;const n=e==null?void 0:e.parentElement,s=d.select(),o=p.select(),l=s.get(t),r=f.getFileStore("readwrite");ye(l,s,o,r);const i=l.parentId,c=s.get(i);(m=c==null?void 0:c.childFolders)==null||m.delete(t),s.delete(t),p.dispatch(o),d.dispatch(s);const a=i===0?I:I==null?void 0:I.querySelector(`.folder[data-obj-id="${i}"]`);C(a??I),n==null||n.remove()}const X=document.getElementById("delete-folder");X&&(X.onclick=()=>{We()});const Y=document.getElementById("clear-app");Y&&(Y.onclick=()=>{window.localStorage.clear(),f.deleteDatabase(),location.reload()});function Xe(){var a;let e=ae();if(!e)return;const t=+e.dataset.objId,n=e==null?void 0:e.parentElement,s=d.select(),o=p.select(),l=f.getFileStore("readwrite");f.deleteFile(t,l);const i=o.get(t).parentId,c=s.get(i);(a=c==null?void 0:c.childFiles)==null||a.delete(t),o.delete(t),p.dispatch(o),d.dispatch(s),de(null),n==null||n.remove()}const G=document.getElementById("delete-file");G&&(G.onclick=()=>{Xe()});function Ye(){const e=document.createElement("form");e.className="form",e.id="file-upload",e.innerHTML=`<label class="file" for="loadfile">
                        <input id="loadfile" name="loadfile" type="file" required/>
                        <span class="file__btn">Выберите файл</span> 
                    </label>
                    <label for="nodename">
                        <span>Название:</span>
                        <input  id="nodename" name="nodename" type="text" />
                    </label>
                    <label for="nodedescr">
                        <span>Описание:</span>
                        <input id="nodedescr" name="nodedescr" type="text" />
                    </label>
                    <button type="submit" form="file-upload">ОК</button>`;const t=e.elements;return t.loadfile.onchange=n=>{if(!t.loadfile.files)return;const s=t.loadfile.files[0];t.nodename.value=s.name},t.loadfile.onclick=n=>{t.loadfile.value=""},t.nodename.oninput=()=>{z(t.nodename.value)&&t.nodename.setCustomValidity("")},document.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),e.dispatchEvent(new Event("submit")))}),e}class Ge{constructor(t,n){g(this,"id");g(this,"file");this.id=t,this.file=n}}function Qe(e,t,n){var h;let s=H();const o=(s==null?void 0:s.dataset.objId)??0,l=d.select(),r=p.select(),i=l.get(+o),c=f.getFileStore("readwrite");if(i&&i.childFiles&&i.childFolders){const he=Array.from(i.childFiles.values()).concat(Array.from(i.childFolders.values()));e=L(i,he,e,"file")}const a=new q(e,"file",+o,t),m=new Ge(a.id,n);f.addFile(m,c),(h=i==null?void 0:i.childFiles)==null||h.set(a.id,a.name),r.set(a.id,a),p.dispatch(r),d.dispatch(l),ge(s,+o,a,ue)}const Q=document.getElementById("upload-file"),F=Ye(),y=F.elements,Z=J(F,()=>{F.reset()});Q&&(Q.onclick=()=>{F.onsubmit=e=>{if(e.preventDefault(),y.nodename.value=w(y.nodename.value),y.nodedescr.value=w(y.nodedescr.value),!U(F)||!y.loadfile.files||!y.loadfile.files[0])return;let n=y.loadfile.files[0];console.log(n),Qe(y.nodename.value,y.nodedescr.value,n),F.reset(),Z.remove()},document.body.insertAdjacentElement("beforeend",Z)});function Ze(){let e=ae();if(!e)return;const t=+e.dataset.objId,n=f.getFileStore("readonly"),o=p.select().get(t);f.getFile(t,n,l=>{console.log("success"),et(l.file,o.name)})}const et=(e,t)=>{let n=document.createElement("a");n.style.display="none",document.body.appendChild(n);const s=window.URL.createObjectURL(e);console.log(s),n.href=s,n.download=t,n.click(),window.URL.revokeObjectURL(s),n.remove()},ee=document.getElementById("download-file");ee&&(ee.onclick=()=>{Ze()});const te=document.getElementById("tabs");function tt(e,t,n,s,o,l){var c,a;const r=e.querySelector(".node__name");if(r&&(r.textContent=o,M(r,l)),te){const m=(c=te.querySelector(`.tab[data-obj-id="${t.id}"]`))==null?void 0:c.querySelector(".tab__filename");m&&(m.textContent=o)}t.name=o,t.descr=l,n.set(t.id,t),p.dispatch(n);const i=s.get(t.parentId);i&&((a=i.childFiles)==null||a.set(t.id,o),s.set(i==null?void 0:i.id,i),d.dispatch(s))}function nt(e,t,n,s,o){var i;const l=e.querySelector(".node__name");l&&(l.textContent=s,M(l,o)),t.name=s,t.descr=o,n.set(t.id,t);const r=n.get(t.parentId);r&&((i=r.childFiles)==null||i.set(t.id,s),n.set(r==null?void 0:r.id,r),d.dispatch(n))}const ne=document.getElementById("update-node"),S=re(),u=S.elements,oe=J(S,()=>{S.reset()});ne&&(ne.onclick=()=>{const e=He();if(!e)return;const t=+e.dataset.objId;if(t===0)return;const n=d.select(),s=p.select();let o;n.has(t)?(o=n.get(t),u.nodename.value=o.name,u.nodedescr.value=o.descr):s.has(t)&&(o=s.get(t),u.nodename.value=o.name,u.nodedescr.value=o.descr),S.onsubmit=l=>{if(l.preventDefault(),u.nodename.value=w(u.nodename.value),u.nodedescr.value=w(u.nodedescr.value),!!U(S)){switch(o.type){case"file":{tt(e,o,s,n,u.nodename.value,u.nodedescr.value);break}default:{nt(e,o,n,u.nodename.value,u.nodedescr.value);break}}S.reset(),oe.remove()}},document.body.insertAdjacentElement("beforeend",oe)});const b="/file-manager";f.openDb();d.initialize();p.initialize();P(0);
